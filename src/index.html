<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
  <title>Vanilla JavaScript App Denis</title>
</head>

<body>
  <main>
    <h1>Vanilla JavaScript App  Denis teste</h1>
  </main>
  
                       <?php
                  

                  
                  $DB_ADDRESS="";
                  $DB_USER="";
                  $DB_PASS="";
                  $DB_NAME="";

                  
                  $SQLKEY="secret";

                   
                  header('Cache-Control: no-cache, must-revalidate');

                  error_log(print_r($_POST,TRUE));

                  if( isset($_POST['query']) && isset($_POST['key']) ){                                   
                    
                    header('Content-type: text/csv');

                    if($_POST['key']==$SQLKEY){                                                          
                      $query=urldecode($_POST['query']);
                      if(get_magic_quotes_gpc()){     
                        $query=stripslashes($query);
                      }
                      $conn = new mysqli($DB_ADDRESS,$DB_USER,$DB_PASS,$DB_NAME);    

                      if($conn->connect_error){                                                           
                        header("HTTP/1.0 400 Bad Request");
                        echo "ERROR Database Connection Failed: " . $conn->connect_error, E_USER_ERROR;   
                      } else {
                        $result=$conn->query($query);                                                     
                        if($result === false){
                          header("HTTP/1.0 400 Bad Request");                                            
                          echo "Wrong SQL: " . $query . " Error: " . $conn->error, E_USER_ERROR;          
                        } else {
                          if (strlen(stristr($query,"SELECT"))>0) {                                       
                            $csv = '';                                                                    
                            while ($fieldinfo = $result->fetch_field()) {
                              $csv .= $fieldinfo->name.",";
                            }
                            $csv = rtrim($csv, ",")."\n";
                            echo $csv;                                                                    
                            $csv = '';

                            $result->data_seek(0);
                            while($row = $result->fetch_assoc()){
                              foreach ($row as $key => $value) {
                                $csv .= $value.",";
                              }
                              $csv = rtrim($csv, ",")."\n";
                            }
                            echo $csv;                                                                    
                          } else {
                            header("HTTP/1.0 201 Rows");
                            echo "AFFECTED ROWS: " . $conn->affected_rows;       
                          }
                        }
                        $conn->close();                                          
                      }
                    } else {
                       header("HTTP/1.0 400 Bad Request");
                       echo "Bad Request";                                       
                    }
                  } else {
                          header("HTTP/1.0 400 Bad Request");
                          echo "Bad Request";
                  }
                  ?>
</body>

</html>
